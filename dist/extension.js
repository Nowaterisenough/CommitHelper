"use strict";var Q=Object.create;var I=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var Y=Object.getOwnPropertyNames;var j=Object.getPrototypeOf,X=Object.prototype.hasOwnProperty;var Z=(i,e)=>{for(var t in e)I(i,t,{get:e[t],enumerable:!0})},G=(i,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Y(e))!X.call(i,s)&&s!==t&&I(i,s,{get:()=>e[s],enumerable:!(o=V(e,s))||o.enumerable});return i};var b=(i,e,t)=>(t=i!=null?Q(j(i)):{},G(e||!i||!i.__esModule?I(t,"default",{value:i,enumerable:!0}):t,i)),ee=i=>G(I({},"__esModule",{value:!0}),i);var ge={};Z(ge,{activate:()=>ce,deactivate:()=>pe});module.exports=ee(ge);var c=b(require("vscode"));var _=b(require("vscode")),T=class{constructor(e="CommitHelper"){this.debugMode=!1;this.outputChannel=_.window.createOutputChannel(e)}setDebugMode(e){this.debugMode=e,this.log(`\u8C03\u8BD5\u6A21\u5F0F: ${e?"\u5F00\u542F":"\u5173\u95ED"}`)}isDebugMode(){return this.debugMode}log(e,t){if(!this.debugMode&&!e.includes("\u9519\u8BEF"))return;let o=new Date().toISOString();if(this.outputChannel.appendLine(`[${o}] ${e}`),t!==void 0)try{this.outputChannel.appendLine(JSON.stringify(t,null,2))}catch{this.outputChannel.appendLine(`[JSON\u5E8F\u5217\u5316\u5931\u8D25]: ${String(t)}`)}this.debugMode&&console.log(`[${o}] ${e}`,t)}error(e,t){let o=new Date().toISOString();if(this.outputChannel.appendLine(`[${o}] \u9519\u8BEF: ${e}`),t!==void 0)if(t instanceof Error)this.outputChannel.appendLine(`  ${t.message}`),t.stack&&this.outputChannel.appendLine(`  ${t.stack}`);else try{this.outputChannel.appendLine(JSON.stringify(t,null,2))}catch{this.outputChannel.appendLine(String(t))}console.error(`[${o}] ${e}`,t)}show(){this.outputChannel.show()}clear(){this.outputChannel.clear()}dispose(){this.outputChannel.dispose()}};var f=class{constructor(e=5,t=100){this.cache=new Map;this.ttl=e*60*1e3,this.maxSize=t;let o=Math.min(this.ttl/2,5*60*1e3);this.cleanupTimer=setInterval(()=>this.cleanup(),o)}set(e,t){if(this.cache.has(e)&&this.cache.delete(e),this.cache.size>=this.maxSize){let o=this.cache.keys().next().value;o!==void 0&&this.cache.delete(o)}this.cache.set(e,{data:t,timestamp:Date.now()})}get(e){let t=this.cache.get(e);if(t){if(Date.now()-t.timestamp>this.ttl){this.cache.delete(e);return}return this.cache.delete(e),this.cache.set(e,t),t.data}}has(e){let t=this.cache.get(e);return t?Date.now()-t.timestamp>this.ttl?(this.cache.delete(e),!1):!0:!1}clear(){this.cache.clear()}delete(e){return this.cache.delete(e)}size(){return this.cache.size}cleanup(){let e=Date.now();for(let[t,o]of this.cache.entries())e-o.timestamp>this.ttl&&this.cache.delete(t)}dispose(){this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=void 0),this.clear()}};var O=b(require("https")),B=b(require("http")),D=require("url"),k=class{constructor(e,t=8e3){this.logger=e,this.defaultTimeout=t,this.maxResponseSize=10*1024*1024,this.httpAgent=new B.Agent({keepAlive:!0,maxSockets:5,maxFreeSockets:2,timeout:t}),this.httpsAgent=new O.Agent({keepAlive:!0,maxSockets:5,maxFreeSockets:2,timeout:t})}async request(e,t={}){let o=new D.URL(e),s=o.protocol==="https:",r=s?O:B,n={hostname:o.hostname,port:o.port||(s?443:80),path:o.pathname+o.search,method:t.method||"GET",headers:{Connection:"keep-alive",...t.headers},timeout:t.timeout||this.defaultTimeout,agent:s?this.httpsAgent:this.httpAgent};return this.logger.log("\u53D1\u8D77HTTP\u8BF7\u6C42",{url:this.sanitizeUrl(e),method:n.method,hostname:n.hostname,keepAlive:!0}),new Promise((l,h)=>{let p=r.request(n,g=>{let u=[],y=0;g.on("data",m=>{u.push(m),y+=m.length,y>this.maxResponseSize&&(p.destroy(),h(new Error("\u54CD\u5E94\u6570\u636E\u8FC7\u5927")))}),g.on("end",()=>{if(this.logger.log("HTTP\u54CD\u5E94",{statusCode:g.statusCode,contentLength:y,headers:{"content-type":g.headers["content-type"],"x-ratelimit-remaining":g.headers["x-ratelimit-remaining"]}}),!g.statusCode||g.statusCode<200||g.statusCode>=300){let m=Buffer.concat(u,y).toString("utf8");h(new Error(`HTTP ${g.statusCode}: ${g.statusMessage}
${m.substring(0,500)}`));return}try{let m=Buffer.concat(u,y).toString("utf8"),L=JSON.parse(m);l(L)}catch(m){let L=Buffer.concat(u,y).toString("utf8");this.logger.error("JSON\u89E3\u6790\u5931\u8D25",{dataLength:L.length,error:m}),h(new Error(`JSON\u89E3\u6790\u5931\u8D25: ${m}`))}})});p.on("error",g=>{this.logger.error("HTTP\u8BF7\u6C42\u9519\u8BEF",g),h(g)}),p.on("timeout",()=>{p.destroy(),h(new Error("\u8BF7\u6C42\u8D85\u65F6"))}),t.body&&p.write(JSON.stringify(t.body)),p.end()})}async requestWithRetry(e,t={},o=2){for(let s=0;s<=o;s++)try{return await this.request(e,t)}catch(r){if(s===o)throw r;await this.sleep(1e3*(s+1))}throw new Error("\u91CD\u8BD5\u5931\u8D25")}sanitizeUrl(e){return e.replace(/token=[^&]+/g,"token=***").replace(/Bearer [^,}]+/g,"Bearer ***")}sleep(e){return new Promise(t=>setTimeout(t,e))}dispose(){this.httpAgent.destroy(),this.httpsAgent.destroy()}};var K=b(require("vscode"));var $={https:/^(https?:\/\/([^\/]+))\/([^\/]+)\/(.+?)(?:\.git)?$/,sshWithPort:/^ssh:\/\/git@([^:\/]+):(\d+)\/([^\/]+)\/(.+?)(?:\.git)?$/,sshStandard:/^git@([^:]+):([^\/]+)\/(.+?)(?:\.git)?$/,sshNoPort:/^ssh:\/\/git@([^\/]+)\/([^\/]+)\/(.+?)(?:\.git)?$/},te={"github.com":"github","gitlab.com":"gitlab","gitee.com":"gitee"},P=class{constructor(e){this.logger=e}parse(e){this.logger.log("\u89E3\u6790Git URL",{url:e});let t=this.parseHttps(e);return t||(t=this.parseSshWithPort(e),t)||(t=this.parseSshStandard(e),t)||(t=this.parseSshNoPort(e),t)?t:(this.logger.log("Git URL\u89E3\u6790\u5931\u8D25"),null)}parseHttps(e){let t=e.match($.https);if(!t)return null;let[,o,s,r,n]=t;return this.logger.log("HTTPS\u683C\u5F0F\u5339\u914D\u6210\u529F",{fullHostUrl:o,hostname:s,owner:r,repo:n}),this.createRepoInfo(s,r,n,o)}parseSshWithPort(e){let t=e.match($.sshWithPort);if(!t)return null;let[,o,s,r,n]=t;if(this.logger.log("SSH\u683C\u5F0F\uFF08\u5E26\u7AEF\u53E3\uFF09\u5339\u914D\u6210\u529F",{hostname:o,port:s,owner:r,repo:n}),this.isKnownPlatform(o))return this.createRepoInfo(o,r,n,`https://${o}`);let l=this.isInternalAddress(o)?"http":"https",h=s==="2222"?"":`:${s}`,p=`${l}://${o}${h}`;return{platform:"local-gitlab",owner:r,repo:n,baseUrl:`${p}/api/v4`,hostUrl:p}}parseSshStandard(e){let t=e.match($.sshStandard);if(!t)return null;let[,o,s,r]=t;if(this.logger.log("SSH\u683C\u5F0F\uFF08\u6807\u51C6\uFF09\u5339\u914D\u6210\u529F",{hostname:o,owner:s,repo:r}),this.isKnownPlatform(o))return this.createRepoInfo(o,s,r,`https://${o}`);let l=`${this.isInternalAddress(o)?"http":"https"}://${o}`;return{platform:"local-gitlab",owner:s,repo:r,baseUrl:`${l}/api/v4`,hostUrl:l}}parseSshNoPort(e){let t=e.match($.sshNoPort);if(!t)return null;let[,o,s,r]=t;if(this.logger.log("SSH\u683C\u5F0F\uFF08\u65E0\u7AEF\u53E3\uFF09\u5339\u914D\u6210\u529F",{hostname:o,owner:s,repo:r}),this.isKnownPlatform(o))return this.createRepoInfo(o,s,r,`https://${o}`);let l=`${this.isInternalAddress(o)?"http":"https"}://${o}`;return{platform:"local-gitlab",owner:s,repo:r,baseUrl:`${l}/api/v4`,hostUrl:l}}isKnownPlatform(e){return Object.keys(te).some(t=>e.includes(t))}isInternalAddress(e){return!!(e.match(/^192\.168\./)||e.match(/^10\./)||e.match(/^172\.(1[6-9]|2[0-9]|3[0-1])\./)||e==="localhost")}createRepoInfo(e,t,o,s){return e.includes("github.com")?{platform:"github",owner:t,repo:o,baseUrl:"https://api.github.com",hostUrl:s}:e.includes("gitlab.com")?{platform:"gitlab",owner:t,repo:o,baseUrl:"https://gitlab.com/api/v4",hostUrl:s}:e.includes("gitee.com")?{platform:"gitee",owner:t,repo:o,baseUrl:"https://gitee.com/api/v5",hostUrl:s}:{platform:"local-gitlab",owner:t,repo:o,baseUrl:`${s}/api/v4`,hostUrl:s}}};var x=class{constructor(e){this.logger=e,this.parser=new P(e),this.cache=new f(30,10)}async getRepoInfo(){let e="current-repo",t=this.cache.get(e);if(t)return this.logger.log("\u4F7F\u7528\u7F13\u5B58\u7684\u4ED3\u5E93\u4FE1\u606F"),t;try{let o=this.getGitApi();if(!o||o.repositories.length===0)return this.logger.log("\u672A\u627E\u5230Git\u4ED3\u5E93"),null;let r=o.repositories[0].state.remotes;if(r.length===0)return this.logger.log("\u672A\u627E\u5230\u8FDC\u7A0B\u4ED3\u5E93"),null;let n=r.find(p=>p.name==="origin")||r[0],l=n.fetchUrl||n.pushUrl;this.logger.log("\u83B7\u53D6\u5230\u8FDC\u7A0BURL",{remoteName:n.name,fetchUrl:l});let h=this.parser.parse(l);return h&&(this.cache.set(e,h),this.logger.log("\u4ED3\u5E93\u4FE1\u606F\u5DF2\u7F13\u5B58",h)),h}catch(o){return this.logger.error("\u83B7\u53D6\u4ED3\u5E93\u4FE1\u606F\u5931\u8D25",o),null}}getGitApi(){if(!this.gitApi){let e=K.extensions.getExtension("vscode.git")?.exports;e&&(this.gitApi=e.getAPI(1))}return this.gitApi}getInputBox(){let e=this.getGitApi();return!e||e.repositories.length===0?null:e.repositories[0].inputBox}clearCache(){this.cache.clear()}dispose(){this.cache.dispose()}};var q=b(require("vscode"));var R=class{constructor(e,t){this.name="github";this.httpClient=e,this.logger=t,this.tokenCache=new f(60)}async getAccessToken(e){let t=`token-${this.name}`,o=this.tokenCache.get(t);if(o)return this.logger.log("\u4F7F\u7528\u7F13\u5B58Token",{platform:this.name}),o;let r=q.workspace.getConfiguration("commitHelper").get("githubToken")||process.env.GITHUB_TOKEN;return r&&this.tokenCache.set(t,r),this.logger.log(`${this.name} Token: ${r?"\u5DF2\u914D\u7F6E":"\u672A\u914D\u7F6E"}`),r}async fetchIssues(e,t,o){let s=[],r=1,n=Math.min(o,50);for(;s.length<o;){let l=`https://api.github.com/repos/${e.owner}/${e.repo}/issues?state=open&page=${r}&per_page=${n}`,h={Authorization:`token ${t}`,Accept:"application/vnd.github.v3+json","User-Agent":"VSCode-CommitHelper"},p=await this.httpClient.requestWithRetry(l,{method:"GET",headers:h});if(!Array.isArray(p)||p.length===0)break;let g=p.map(u=>({id:u.id,title:u.title,number:u.number,state:u.state,url:u.html_url}));if(s.push(...g),p.length<n)break;r++}return s.slice(0,o)}dispose(){this.tokenCache.dispose()}};var U=b(require("vscode"));var C=class{constructor(e,t,o=!1){this.name=o?"local-gitlab":"gitlab",this.httpClient=e,this.logger=t,this.tokenCache=new f(60)}async getAccessToken(e){let t=`token-${this.name}-${e.hostUrl||"default"}`,o=this.tokenCache.get(t);if(o)return this.logger.log("\u4F7F\u7528\u7F13\u5B58Token",{platform:this.name}),o;let s=U.workspace.getConfiguration("commitHelper"),r;return this.name==="local-gitlab"?(r=s.get("localGitlabToken")||process.env.LOCAL_GITLAB_TOKEN,r||(r=s.get("gitlabToken")||process.env.GITLAB_TOKEN),!r&&e.hostUrl&&(r=this.getTokenForHost(e.hostUrl))):r=s.get("gitlabToken")||process.env.GITLAB_TOKEN,r&&this.tokenCache.set(t,r),this.logger.log(`${this.name} Token: ${r?"\u5DF2\u914D\u7F6E":"\u672A\u914D\u7F6E"}`),r}async fetchIssues(e,t,o){let s=[],r=1,n=Math.min(o,50),l=e.repo.replace(/\.git$/,""),h=encodeURIComponent(`${e.owner}/${l}`);for(;s.length<o;){let p=`${e.baseUrl}/projects/${h}/issues?state=opened&page=${r}&per_page=${n}`,g={Authorization:`Bearer ${t}`,"Content-Type":"application/json"},u=await this.httpClient.requestWithRetry(p,{method:"GET",headers:g});if(!Array.isArray(u)||u.length===0)break;let y=u.map(m=>({id:m.iid,title:m.title,number:m.iid,state:m.state,url:m.web_url}));if(s.push(...y),u.length<n)break;r++}return s.slice(0,o)}getTokenForHost(e){try{let t=new URL(e).hostname,o=[`gitlabToken.${t}`,`localGitlabToken.${t}`,`gitlab.${t}.token`,`tokens.${t}`],s=U.workspace.getConfiguration();for(let r of o){let n=s.get(`commitHelper.${r}`);if(n)return n}}catch(t){this.logger.error(`\u89E3\u6790hostUrl\u5931\u8D25: ${t}`)}}dispose(){this.tokenCache.dispose()}};var F=b(require("vscode"));var A=class{constructor(e,t){this.name="gitee";this.httpClient=e,this.logger=t,this.tokenCache=new f(60)}async getAccessToken(e){let t=`token-${this.name}`,o=this.tokenCache.get(t);if(o)return this.logger.log("\u4F7F\u7528\u7F13\u5B58Token",{platform:this.name}),o;let r=F.workspace.getConfiguration("commitHelper").get("giteeToken")||process.env.GITEE_TOKEN;return r&&this.tokenCache.set(t,r),this.logger.log(`${this.name} Token: ${r?"\u5DF2\u914D\u7F6E":"\u672A\u914D\u7F6E"}`),r}async fetchIssues(e,t,o){let s=[],r=1,n=Math.min(o,50);for(;s.length<o;){let l=`https://gitee.com/api/v5/repos/${e.owner}/${e.repo}/issues?state=open&access_token=${t}&page=${r}&per_page=${n}`,h={Accept:"application/json","User-Agent":"VSCode-CommitHelper"},p=await this.httpClient.requestWithRetry(l,{method:"GET",headers:h});if(!Array.isArray(p)||p.length===0)break;let g=p.map(u=>({id:u.id,title:u.title,number:u.number,state:u.state,url:u.html_url}));if(s.push(...g),p.length<n)break;r++}return s.slice(0,o)}dispose(){this.tokenCache.dispose()}};var S=class{constructor(e,t){this.platforms=new Map,this.platforms.set("github",new R(e,t)),this.platforms.set("gitlab",new C(e,t,!1)),this.platforms.set("local-gitlab",new C(e,t,!0)),this.platforms.set("gitee",new A(e,t))}getPlatform(e){let t=this.platforms.get(e);return t||null}dispose(){for(let e of this.platforms.values())"dispose"in e&&typeof e.dispose=="function"&&e.dispose();this.platforms.clear()}};var M=class{constructor(){this.config={debug:!1,maxIssues:50,requestTimeout:8e3};this.logger=new T("CommitHelper"),this.httpClient=new k(this.logger,this.config.requestTimeout),this.repoManager=new x(this.logger),this.platformFactory=new S(this.httpClient,this.logger),this.issueCache=new f(10,50),this.logger.log("AppContext \u521D\u59CB\u5316\u5B8C\u6210")}setDebugMode(e){this.config.debug=e,this.logger.setDebugMode(e)}isDebugMode(){return this.config.debug}getMaxIssues(){return this.config.maxIssues}getRequestTimeout(){return this.config.requestTimeout}clearAllCaches(){this.issueCache.clear(),this.repoManager.clearCache(),this.logger.log("\u6240\u6709\u7F13\u5B58\u5DF2\u6E05\u9664")}dispose(){this.logger.log("AppContext \u6B63\u5728\u9500\u6BC1"),this.issueCache.dispose(),this.repoManager.dispose(),this.platformFactory.dispose(),this.httpClient.dispose(),this.logger.dispose()}};var v=b(require("vscode"));var oe=[/^(feat|fix|docs?|style|refactor|test|chore|perf|ci|build|revert|hotfix|security|update|add|remove)(\(.+?\))?!?\s*[:：]\s*/i,/^\[?(feat|fix|docs?|style|refactor|test|chore|perf|ci|build|revert|hotfix|security|update|add|remove)\]?\s*[:：]?\s*/i];function z(i){if(!i)return i;let e=[/^(?:\[[^\]]+\]|【[^】]+】|\([^)]+\)|[A-Z]+[-:])\s*-?\s*/,/^(feat|fix|docs?|style|refactor|test|chore|perf|ci|build|revert|hotfix|security|update|add|remove)(\(.+?\))?!?\s*[:：]\s*/i,/^\[?(feat|fix|docs?|style|refactor|test|chore|perf|ci|build|revert|hotfix|security|update|add|remove)\]?\s*[:：]?\s*/i,/^(新功能|功能|修复|修改|文档|样式|重构|测试|维护|性能|持续集成|构建|回滚|热修复|安全|更新|添加|删除)[:：]\s*/],t=i;for(let o of e){let s=t.replace(o,"").trim();if(s&&s!==t){t=s;break}}return!t||t.length<3?i:t}function N(i){let e=i;for(let t of oe)e=e.replace(t,"").trim();return e=e.replace(/\n\nBREAKING CHANGE:.*$/s,"").trim(),e=e.replace(/\n\nCloses #\d+$/gm,"").trim(),e||i}function W(){return[{label:"feat",detail:"\u6DFB\u52A0\u65B0\u7684\u529F\u80FD\u7279\u6027"},{label:"fix",detail:"\u4FEE\u590D\u4EE3\u7801\u4E2D\u7684\u9519\u8BEF"},{label:"docs",detail:"\u4EC5\u6587\u6863\u76F8\u5173\u7684\u66F4\u6539"},{label:"style",detail:"\u4E0D\u5F71\u54CD\u4EE3\u7801\u542B\u4E49\u7684\u66F4\u6539\uFF08\u7A7A\u683C\u3001\u683C\u5F0F\u5316\u3001\u7F3A\u5C11\u5206\u53F7\u7B49\uFF09"},{label:"refactor",detail:"\u65E2\u4E0D\u4FEE\u590Dbug\u4E5F\u4E0D\u6DFB\u52A0\u529F\u80FD\u7684\u4EE3\u7801\u66F4\u6539"},{label:"test",detail:"\u6DFB\u52A0\u7F3A\u5931\u7684\u6D4B\u8BD5\u6216\u66F4\u6B63\u73B0\u6709\u6D4B\u8BD5"},{label:"chore",detail:"\u5BF9\u6784\u5EFA\u8FC7\u7A0B\u6216\u8F85\u52A9\u5DE5\u5177\u548C\u5E93\u7684\u66F4\u6539"},{label:"perf",detail:"\u63D0\u9AD8\u6027\u80FD\u7684\u4EE3\u7801\u66F4\u6539"},{label:"ci",detail:"CI\u914D\u7F6E\u6587\u4EF6\u548C\u811A\u672C\u7684\u66F4\u6539"},{label:"build",detail:"\u5F71\u54CD\u6784\u5EFA\u7CFB\u7EDF\u6216\u5916\u90E8\u4F9D\u8D56\u7684\u66F4\u6539"},{label:"revert",detail:"\u6062\u590D\u4E4B\u524D\u7684\u63D0\u4EA4"}]}var H=class{constructor(e){this.ctx=e}async fetchIssues(e){let t=`${e.platform}-${e.owner}-${e.repo}`,o=this.ctx.issueCache.get(t);if(o)return this.ctx.logger.log("\u4F7F\u7528\u7F13\u5B58\u7684\u8BAE\u9898\u6570\u636E",{count:o.length}),o;let s=this.ctx.platformFactory.getPlatform(e.platform);if(!s)throw new Error(`\u4E0D\u652F\u6301\u7684\u5E73\u53F0: ${e.platform}`);let r=await s.getAccessToken(e);if(!r){let l=`\u672A\u627E\u5230 ${e.platform} \u7684\u8BBF\u95EE\u4EE4\u724C\uFF0C\u8BF7\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6E`;throw this.ctx.logger.error(l),new Error(l)}let n=await s.fetchIssues(e,r,this.ctx.getMaxIssues());return this.ctx.issueCache.set(t,n),this.ctx.logger.log("\u8BAE\u9898\u83B7\u53D6\u6210\u529F",{totalCount:n.length,platform:e.platform}),n}async refreshIssues(e){let t=`${e.platform}-${e.owner}-${e.repo}`;return this.ctx.issueCache.delete(t),this.fetchIssues(e)}async determineCommitTitle(e,t,o){if(o){let n=N(e.trim());return this.ctx.logger.log("\u4F7F\u7528\u73B0\u6709\u63D0\u4EA4\u6D88\u606F\u5185\u5BB9",{original:e,extracted:n}),n||e.trim()}if(t){let n=z(t.title);return this.ctx.logger.log("\u4F7F\u7528\u8BAE\u9898\u6807\u9898",{rawTitle:t.title,cleanedTitle:n}),n}let s=await v.window.showInputBox({prompt:"\u8F93\u5165\u63D0\u4EA4\u63CF\u8FF0",placeHolder:"\u7B80\u8981\u63CF\u8FF0\u672C\u6B21\u63D0\u4EA4\u7684\u5185\u5BB9"});if(!s||!s.trim())return this.ctx.logger.log("\u7528\u6237\u672A\u8F93\u5165\u63D0\u4EA4\u63CF\u8FF0"),null;let r=s.trim();return this.ctx.logger.log("\u7528\u6237\u624B\u52A8\u8F93\u5165\u7684\u6807\u9898",{title:r}),r}async getCommitTypeAndScope(){let e=W(),t=!1;for(;;){let o=[{label:`${t?"$(check)":"$(circle-outline)"} Breaking Change`,description:"\u70B9\u51FB\u8BBE\u7F6E\u4E3ABreaking Change\u7C7B\u578B(\u7834\u574F\u6027\u53D8\u66F4)",__toggle:!0},{label:"",kind:v.QuickPickItemKind.Separator},...e.map(l=>({label:l.label,detail:l.detail,__type:l.label}))],s=await v.window.showQuickPick(o,{placeHolder:`\u9009\u62E9\u63D0\u4EA4\u7C7B\u578B${t?" (\u5F53\u524D\u4E3A Breaking Change)":""}`,matchOnDetail:!0});if(!s)return this.ctx.logger.log("\u7528\u6237\u672A\u9009\u62E9\u63D0\u4EA4\u7C7B\u578B"),null;if(s.kind===v.QuickPickItemKind.Separator)continue;if(s.__toggle){t=!t;continue}let r=s.__type;this.ctx.logger.log("\u7528\u6237\u9009\u62E9\u7684\u63D0\u4EA4\u7C7B\u578B",{type:r,isBreaking:t});let n=await v.window.showInputBox({prompt:"\u8F93\u5165\u4F5C\u7528\u57DF\uFF08\u53EF\u9009\uFF09",placeHolder:"\u4F8B\u5982\uFF1Aapi, ui, auth"});return this.ctx.logger.log("\u7528\u6237\u8F93\u5165\u7684\u4F5C\u7528\u57DF",{scope:n||"\u65E0"}),{commitType:r,scope:n||"",cancelled:!1,isBreaking:t}}}generateCommitMessage(e){let t=N(e.title),o=e.type;return e.scope&&e.scope.trim()&&(o+=`(${e.scope.trim()})`),e.isBreaking&&(o+="!"),o+=`: ${t}`,e.isBreaking&&(o+=`

BREAKING CHANGE: \u8FD9\u662F\u4E00\u4E2A\u7834\u574F\u6027\u53D8\u66F4\uFF0C\u53EF\u80FD\u5F71\u54CD\u73B0\u6709\u529F\u80FD\u7684\u4F7F\u7528\u65B9\u5F0F`),e.issues.length>0&&(o+=`

Closes #${e.issues[0].number}`),o}};var d=b(require("vscode")),E=class{constructor(e){this.service=e}async pick(e,t,o){let s=e;for(;;){let r=this.createPickItems(s),n=await d.window.showQuickPick(r,{placeHolder:t?"\u9009\u62E9\u8981\u7ED1\u5B9A\u7684\u8BAE\u9898\uFF08\u5F53\u524D\u5DF2\u6709\u63D0\u4EA4\u5185\u5BB9\uFF0C\u5C06\u4FDD\u7559\u73B0\u6709\u5185\u5BB9\uFF09":"\u9009\u62E9\u8981\u7ED1\u5B9A\u7684\u8BAE\u9898\u6216\u4E0D\u7ED1\u5B9A\u8BAE\u9898",matchOnDescription:!0,matchOnDetail:!0});if(n===void 0)return{selectedIssue:null,userCancelled:!0};if(!(n.action==="separator"||n.kind===d.QuickPickItemKind.Separator)){if(n.action==="refresh"){let l=await this.refreshIssues(o);l&&(s=l,d.window.showInformationMessage(`\u8BAE\u9898\u5217\u8868\u5DF2\u5237\u65B0\uFF0C\u5171\u627E\u5230 ${s.length} \u4E2A\u8BAE\u9898`));continue}if(n.action==="manual"){let l=await this.handleManualBinding();if(l)return{selectedIssue:l,userCancelled:!1};continue}if(n.action!=="info")return{selectedIssue:n.issue,userCancelled:!1}}}}createPickItems(e){let t=[{label:"$(refresh) \u5237\u65B0\u8BAE\u9898\u5217\u8868",description:"\u91CD\u65B0\u83B7\u53D6\u6700\u65B0\u7684\u8BAE\u9898\u5217\u8868",action:"refresh",issue:null},{label:"$(edit) \u624B\u52A8\u7ED1\u5B9A\u8BAE\u9898",description:"\u624B\u52A8\u8F93\u5165\u8BAE\u9898\u7F16\u53F7\u8FDB\u884C\u7ED1\u5B9A",action:"manual",issue:null},{label:"$(x) \u4E0D\u7ED1\u5B9A\u8BAE\u9898",description:"\u672C\u6B21\u63D0\u4EA4\u4E0D\u5173\u8054\u4EFB\u4F55\u8BAE\u9898",action:"none",issue:null}];if(e.length===0)t.splice(0,1),t.unshift({label:"$(info) \u672A\u627E\u5230\u8BAE\u9898",description:"\u5F53\u524D\u4ED3\u5E93\u6CA1\u6709\u6253\u5F00\u7684\u8BAE\u9898",action:"info",issue:null});else{t.push({label:"",description:"",action:"separator",issue:null,kind:d.QuickPickItemKind.Separator});let o=e.map(s=>({label:s.title.length>100?s.title.substring(0,100)+"...":s.title,detail:`#${s.number}`,action:"select",issue:s}));t.push(...o)}return t}async refreshIssues(e){try{return await d.window.withProgress({location:d.ProgressLocation.Notification,title:"\u6B63\u5728\u5237\u65B0\u8BAE\u9898\u5217\u8868...",cancellable:!1},async o=>{o.report({increment:0,message:"\u8FDE\u63A5\u5230\u8FDC\u7A0B\u4ED3\u5E93..."});let s=await this.service.refreshIssues(e);return o.report({increment:100,message:"\u8BAE\u9898\u83B7\u53D6\u5B8C\u6210"}),s})}catch(t){return d.window.showErrorMessage(t.message||"\u5237\u65B0\u8BAE\u9898\u5931\u8D25"),null}}async handleManualBinding(){let e=await d.window.showInputBox({prompt:"\u8F93\u5165\u8BAE\u9898\u7F16\u53F7",placeHolder:"\u4F8B\u5982\uFF1A123 \u6216 #123",validateInput:s=>{if(!s)return;let r=s.replace("#",""),n=parseInt(r,10);if(isNaN(n)||n<=0)return"\u8BF7\u8F93\u5165\u6709\u6548\u7684\u8BAE\u9898\u7F16\u53F7"}});if(!e)return null;let t=parseInt(e.replace("#",""),10),o={id:t,number:t,title:`\u624B\u52A8\u7ED1\u5B9A\u7684\u8BAE\u9898 #${t}`,state:"open",url:""};return d.window.showInformationMessage(`\u5DF2\u624B\u52A8\u7ED1\u5B9A\u8BAE\u9898 #${t}`),o}};var a,w,J;async function se(){a.logger.log("\u5F00\u59CB\u683C\u5F0F\u5316\u63D0\u4EA4\u6D88\u606F");try{let i=await a.repoManager.getRepoInfo();if(!i){c.window.showErrorMessage("\u65E0\u6CD5\u83B7\u53D6\u4ED3\u5E93\u4FE1\u606F\uFF0C\u8BF7\u786E\u4FDD\u5728Git\u4ED3\u5E93\u4E2D\u6253\u5F00\u9879\u76EE");return}a.logger.log("\u4ED3\u5E93\u4FE1\u606F\u83B7\u53D6\u6210\u529F",i);let e=a.repoManager.getInputBox();if(!e){c.window.showErrorMessage("\u65E0\u6CD5\u83B7\u53D6Git\u8F93\u5165\u6846");return}let t=e.value||"",o=t.trim().length>0;a.logger.log("\u5F53\u524D\u63D0\u4EA4\u6D88\u606F\u72B6\u6001",{hasContent:o,length:t.length});let s;try{s=await c.window.withProgress({location:c.ProgressLocation.Notification,title:"\u6B63\u5728\u83B7\u53D6\u8BAE\u9898\u5217\u8868...",cancellable:!0},async(g,u)=>{let y=await w.fetchIssues(i);if(u.isCancellationRequested)throw new Error("\u7528\u6237\u53D6\u6D88\u64CD\u4F5C");return y})}catch(g){if(g.message&&g.message.includes("\u7528\u6237\u53D6\u6D88"))return;a.logger.error("\u83B7\u53D6\u8BAE\u9898\u5931\u8D25",g),c.window.showErrorMessage(g.message||"\u83B7\u53D6\u8BAE\u9898\u5931\u8D25");return}let{selectedIssue:r,userCancelled:n}=await J.pick(s,o,i);if(n)return;let l=await w.determineCommitTitle(t,r,o);if(!l)return;let h=await w.getCommitTypeAndScope();if(!h)return;let p=w.generateCommitMessage({type:h.commitType,scope:h.scope,title:l,issues:r?[r]:[],isBreaking:h.isBreaking});e.value=p,a.logger.log("\u63D0\u4EA4\u6D88\u606F\u751F\u6210\u5B8C\u6210",{hasIssue:!!r,issueNumber:r?.number,messageLength:p.length}),c.window.showInformationMessage(r?`\u63D0\u4EA4\u6D88\u606F\u5DF2\u751F\u6210\u5E76\u7ED1\u5B9A\u8BAE\u9898 #${r.number}\uFF01`:"\u63D0\u4EA4\u6D88\u606F\u5DF2\u751F\u6210\uFF01")}catch(i){let e=`\u683C\u5F0F\u5316\u63D0\u4EA4\u6D88\u606F\u5931\u8D25: ${i.message}`;a.logger.error(e,i),c.window.showErrorMessage(e)}}async function re(){a.logger.log("=== \u5F00\u59CB\u6D4B\u8BD5\u914D\u7F6E ===");try{let i=await a.repoManager.getRepoInfo();if(!i){c.window.showErrorMessage("\u65E0\u6CD5\u83B7\u53D6\u4ED3\u5E93\u4FE1\u606F");return}a.logger.log("\u4ED3\u5E93\u4FE1\u606F",i);let e=a.platformFactory.getPlatform(i.platform);if(!e){c.window.showErrorMessage(`\u4E0D\u652F\u6301\u7684\u5E73\u53F0: ${i.platform}`);return}let t=await e.getAccessToken(i);if(!t){c.window.showErrorMessage(`\u672A\u627E\u5230 ${i.platform} \u7684\u8BBF\u95EE\u4EE4\u724C\uFF0C\u8BF7\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6E`);return}a.logger.log("Token\u83B7\u53D6\u6210\u529F",{platform:i.platform,tokenPrefix:t.substring(0,8)+"..."});let o=await w.fetchIssues(i);c.window.showInformationMessage(`\u914D\u7F6E\u6D4B\u8BD5\u5B8C\u6210\uFF01\u627E\u5230 ${o.length} \u4E2A\u8BAE\u9898\u3002\u8BE6\u60C5\u8BF7\u67E5\u770B\u8F93\u51FA\u9762\u677F\u3002`)}catch(i){let e=`\u914D\u7F6E\u6D4B\u8BD5\u5931\u8D25: ${i.message}`;a.logger.error(e,i),c.window.showErrorMessage(e)}}async function ie(){let i=c.workspace.getConfiguration("commitHelper");a.logger.log("=== \u914D\u7F6E\u8C03\u8BD5\u4FE1\u606F ==="),a.logger.log("CommitHelper\u914D\u7F6E:",{localGitlabToken:i.get("localGitlabToken")?"\u5DF2\u914D\u7F6E":"\u672A\u914D\u7F6E",gitlabToken:i.get("gitlabToken")?"\u5DF2\u914D\u7F6E":"\u672A\u914D\u7F6E",githubToken:i.get("githubToken")?"\u5DF2\u914D\u7F6E":"\u672A\u914D\u7F6E",giteeToken:i.get("giteeToken")?"\u5DF2\u914D\u7F6E":"\u672A\u914D\u7F6E"});let e=await a.repoManager.getRepoInfo();if(e){a.logger.log("\u4ED3\u5E93\u4FE1\u606F:",e);let t=a.platformFactory.getPlatform(e.platform);if(t){let o=await t.getAccessToken(e);a.logger.log("\u6700\u7EC8\u83B7\u53D6\u7684Token:",o?o.substring(0,8)+"...":"none")}}c.window.showInformationMessage("\u914D\u7F6E\u8C03\u8BD5\u4FE1\u606F\u5DF2\u8F93\u51FA\u5230CommitHelper\u9891\u9053")}async function ne(){try{a.logger.log("=== Git\u4ED3\u5E93\u8C03\u8BD5\u4FE1\u606F ===");let i=await a.repoManager.getRepoInfo();if(!i){a.logger.log("\u672A\u627E\u5230Git\u4ED3\u5E93");return}a.logger.log("\u4ED3\u5E93\u4FE1\u606F:",i);let e=a.platformFactory.getPlatform(i.platform);if(e){let t=await e.getAccessToken(i);a.logger.log("Token\u83B7\u53D6\u7ED3\u679C:",{platform:i.platform,hasToken:!!t,tokenPrefix:t?t.substring(0,8)+"...":"none"})}c.window.showInformationMessage("\u8C03\u8BD5\u4FE1\u606F\u5DF2\u8F93\u51FA\u5230CommitHelper\u9891\u9053")}catch(i){a.logger.error("\u8C03\u8BD5\u5931\u8D25",i)}}async function ae(){a.clearAllCaches(),c.window.showInformationMessage("\u6240\u6709\u7F13\u5B58\u5DF2\u6E05\u9664")}async function le(){let i=!a.isDebugMode();a.setDebugMode(i),c.window.showInformationMessage(`\u8C03\u8BD5\u6A21\u5F0F: ${i?"\u5F00\u542F":"\u5173\u95ED"}`)}function ce(i){a=new M,w=new H(a),J=new E(w),a.logger.log("CommitHelper \u63D2\u4EF6\u5DF2\u6FC0\u6D3B");let e=[c.commands.registerCommand("CommitHelper.formatMessage",se),c.commands.registerCommand("CommitHelper.testConfig",re),c.commands.registerCommand("CommitHelper.debugConfig",ie),c.commands.registerCommand("CommitHelper.debugRepo",ne),c.commands.registerCommand("CommitHelper.clearCache",ae),c.commands.registerCommand("CommitHelper.toggleDebug",le)];i.subscriptions.push(...e),i.subscriptions.push({dispose:()=>{a.dispose()}})}function pe(){a&&a.dispose()}0&&(module.exports={activate,deactivate});
